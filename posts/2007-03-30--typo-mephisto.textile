
|layout: post|
|title: &quot;又从 Typo 搬到 Mephisto 了......&quot;|
|date: 2007-03-30|
|comments: false|


<div class='post'>
<h3>
Hack 1: 文章 meta 的修改
</h3>
<br/><br/>
<p>
这里的 meta 是指每个 entry 下面一小块区域，包括文章作者、所属分类等信息，以及指向评论的链接。最初的模板没有订阅评论的链接，也没有文章所属 tag 的信息，所以改动模板的 &#95;shared.liquid 文件如下，加入：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/></tt>2<tt><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/></tt>     <span class="ta">&lt;span</span> <span class="an">class</span>=<span class="s"><span class="dl">&quot;</span><span class="k">tag</span><span class="dl">&quot;</span></span><span class="ta">&gt;</span>Tagged {{ article | linked_tag_list }}<span class="ta">&lt;/span&gt;</span><tt><br/><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<p>
以及：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/></tt>2<tt><br/></tt>3<tt><br/></tt>4<tt><br/></tt><strong>5</strong><tt><br/><br/></tt>6<tt><br/></tt>7<tt><br/></tt>8<tt><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/></tt>       {% unless mode == 'single' %}<tt><br/></tt>        {% if article.accept_comments %}<tt><br/></tt>        <span class="ta">&lt;a</span> <span class="an">href</span>=<span class="s"><span class="dl">&quot;</span><span class="k">{{ article.url }}#comments</span><span class="dl">&quot;</span></span> <span class="an">class</span>=<span class="s"><span class="dl">&quot;</span><span class="k">commentslink</span><span class="dl">&quot;</span></span><span class="ta">&gt;</span><tt><br/><br/></tt>        {{ article.comments_count | pluralize: 'comments' }}  <span class="en">&amp;#187;</span><span class="ta">&lt;/a&gt;</span> <span class="en">&amp;nbsp;</span> <tt><br/></tt>        <span class="ta">&lt;a</span> <span class="an">href</span>=<span class="s"><span class="dl">&quot;</span><span class="k">{{ article.comments_feed_url }}</span><span class="dl">&quot;</span></span> <span class="an">class</span>=<span class="s"><span class="dl">&quot;</span><span class="k">commentslink</span><span class="dl">&quot;</span></span><span class="ta">&gt;</span><tt><br/><br/></tt>        Subscribe to comments<span class="ta">&lt;/a&gt;</span>{% endif %}<tt><br/></tt>      {% endunless %}<tt><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<p>
代码基本是自解释的，我就不说啥了。
</p>
<br/><br/>
<h3>
Hack 2: 每次都要折腾的分类 feed 链接
</h3>
<br/><br/>
<p>
分类的链接比较简单，<a href="http://mephisto.stikipad.com/">Mephisto 的 wiki</a> 上有说明，另有一个 articles&#95;feed 的 filter 可以帮助获取用于自动识别的 feed，加上后会在 html 的 &lt;head&amp;rt; 部分加入 feed 地址，像 Firefox 这样的浏览器就可以自动发现这些 feed。但为了让使用 IE 之类浏览器的人也能看到 feed，就比较麻烦，google 了半天之后发现 mephisto 提供了一个 helper，叫 section&#95;feed&#95;url，终于搞定，代码是这个样子：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/></tt>2<tt><br/></tt>3<tt><br/><br/></tt>4<tt><br/></tt><strong>5</strong><tt><br/></tt>6<tt><br/></tt>7<tt><br/></tt>8<tt><br/></tt>9<tt><br/></tt><strong>10</strong><tt><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/><br/></tt>      <span class="ta">&lt;ul&gt;</span><tt><br/></tt>       {% for category in site.blog_sections %}<tt><br/></tt>       {% unless category.name == 'Home' %}<tt><br/></tt>       <span class="ta">&lt;li&gt;</span>{{ category | link_to_section  }} ({{ category.articles_count }}) <tt><br/></tt>       {{ category | articles_feed }} <tt><br/></tt>       <span class="ta">&lt;a</span> <span class="an">href</span>=<span class="s"><span class="dl">&quot;</span><span class="k">{{ category | section_feed_url }}</span><span class="dl">&quot;</span></span> <span class="an">class</span>=<span class="s"><span class="dl">&quot;</span><span class="k">tiny</span><span class="dl">&quot;</span></span><span class="ta">&gt;</span>(atom)<span class="ta">&lt;/a&gt;</span><tt><br/><br/></tt>       <span class="ta">&lt;/li&gt;</span><tt><br/></tt>       {% endunless %}{% endfor %}<tt><br/></tt>       <span class="ta">&lt;/ul&gt;</span><tt><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<p>
折腾了一通之后发现有人写了<a href="http://svn.exdolo.com/projects/plugins/mephisto_section_feeds/">插件</a>提供这个功能......另外 Home 分类是默认的，就是全部文章，这里用 unless 把它去掉。
</p>
<br/><br/>
<h3>
Hack 3: 最近评论
</h3>
<br/><br/>
<p>
这是 0.7.3 最新支持的功能，在 CHANGELOG 里他们给出了一种用法，但无论怎么改参数，给出的评论数总是跟默认的页面文章数一致，似乎是参数没有传递过去。后来还是在 <a href="http://mephisto.stikipad.com/">Mephisto Wiki</a> 上的提问与回答部分找到了一段代码，依葫芦画瓢：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/></tt>2<tt><br/></tt>3<tt><br/><br/></tt>4<tt><br/></tt><strong>5</strong><tt><br/></tt>6<tt><br/></tt>7<tt><br/></tt>8<tt><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/></tt>        {{ site | latest_comments:5 | assign_to:&quot;comments&quot; }}<tt><br/><br/></tt>         <span class="ta">&lt;ul&gt;</span><tt><br/></tt>            {% for comment in comments %}<tt><br/></tt>              <span class="ta">&lt;li&gt;</span>{{ comment.author_link }}  on {{ comment | link_to_article }} - <tt><br/></tt>                   {{ comment.body | truncatewords: 10 }}<span class="ta">&lt;/li&gt;</span><tt><br/></tt>            {% endfor %}<tt><br/><br/></tt>         <span class="ta">&lt;/ul&gt;</span><tt><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<p>
至今也不明白为什么像 <code>{{ site &#124; latest&#95;comments :5 }}</code> 这样的代码不行，非得用 <code>assign&#95;to</code>。
</p>
<br/><br/>
<h3>
Hack 4: 每月文章
</h3>
<br/><br/>
<p>
这个也是 <a href="http://mephisto.stikipad.com/">Mephisto Wiki</a> 上直接给了解决办法的，直接贴出代码：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/></tt>2<tt><br/></tt>3<tt><br/></tt>4<tt><br/></tt><strong>5</strong><tt><br/><br/></tt>6<tt><br/></tt>7<tt><br/></tt>8<tt><br/></tt>9<tt><br/></tt><strong>10</strong><tt><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/></tt>      <span class="ta">&lt;ul&gt;</span><tt><br/></tt>      {% for month in site.home_section.months  %}<tt><br/><br/></tt>      {{ site.home_section | monthly_articles: month | size | assign_to: 'articles_count' }}<tt><br/></tt>        {% if articles_count <span class="er">&gt;</span> 0 %}<tt><br/></tt>        <span class="ta">&lt;li&gt;</span>{{ site.home_section | link_to_month: month }} <tt><br/></tt>        ({{ articles_count }})<span class="ta">&lt;/li&gt;</span><tt><br/></tt>        {% endif %}<tt><br/><br/></tt>      {% endfor %}<tt><br/></tt>      <span class="ta">&lt;/ul&gt;</span><tt><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<h3>
Hack 5: 分类存档
</h3>
<br/><br/>
<p>
我最得意的 hack :)。Mephisto 的作者非常痛恨 blog 分页，据说是因为这样文章的链接会随其页面位置改变，不方便别人用搜索引擎查找，所以 Mephisto 默认没有分页功能，也没有“上一页”这样的选项。还好每月的文章是可以全部显示的，但查看分类、搜索和首页的文章数等等都要受同一个变量的控制。首页没有早期文章的链接还可以忍，分类也只能看十几篇就比较过分了，好在摸索之后发现每个分类也是可以按照月份显示所有文章的，通过以下代码：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/><br/></tt>2<tt><br/></tt>3<tt><br/></tt>4<tt><br/></tt><strong>5</strong><tt><br/></tt>6<tt><br/></tt>7<tt><br/></tt>8<tt><br/></tt>9<tt><br/></tt><strong>10</strong><tt><br/><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/></tt>    <span class="ta">&lt;ul&gt;</span><tt><br/></tt>    {% for month in section.months  %}<tt><br/></tt>    {{ section | monthly_articles: month | size | assign_to: 'articles_count' }}<tt><br/></tt>        {% if articles_count <span class="er">&gt;</span> 0 %}<tt><br/><br/></tt>        <span class="ta">&lt;li</span> <span class="an">class</span>=<span class="s"><span class="dl">&quot;</span><span class="k">month</span><span class="dl">&quot;</span></span><span class="ta">&gt;</span>{{ section | link_to_month: month }} <tt><br/></tt>         ({{ articles_count }}) <span class="ta">&lt;/li&gt;</span><tt><br/></tt>        {% endif %}<tt><br/></tt>    {% endfor %}<tt><br/><br/></tt>    <span class="ta">&lt;/ul&gt;</span><tt><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<p>
建立一个分类页面专用的模板，在 sidebar 部分加入即可通过每月文章访问到分类中所有的文章。但是这样跟我所要的效果还有一些差距。怎样能看到所有文章的标题呢？参考上面的代码，我依葫芦画瓢写了如下的代码，试验了一下，运气不错：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/></tt>2<tt><br/></tt>3<tt><br/><br/></tt>4<tt><br/></tt><strong>5</strong><tt><br/></tt>6<tt><br/></tt>7<tt><br/></tt>8<tt><br/></tt>9<tt><br/></tt><strong>10</strong><tt><br/></tt>11<tt><br/></tt>12<tt><br/><br/></tt>13<tt><br/></tt>14<tt><br/></tt><strong>15</strong><tt><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/></tt>    <span class="ta">&lt;ul&gt;</span><tt><br/></tt>        {% for month in section.months  %}<tt><br/></tt>        {{ section | monthly_articles: month | size | assign_to: 'articles_count' }}<tt><br/><br/></tt>            {% if articles_count <span class="er">&gt;</span> 0 %}<tt><br/></tt>            <span class="ta">&lt;li</span> <span class="an">class</span>=<span class="s"><span class="dl">&quot;</span><span class="k">month</span><span class="dl">&quot;</span></span><span class="ta">&gt;</span>{{ section | link_to_month: month }} <tt><br/></tt>               ({{ articles_count }})<tt><br/></tt>            {{ section | monthly_articles: month | assign_to: 'articlesmonth' }}<tt><br/><br/></tt>                {% for article in articlesmonth %}<tt><br/></tt>                    <span class="ta">&lt;li&gt;</span>{{ article | link_to_article }}<span class="ta">&lt;/li&gt;</span><tt><br/></tt>                {% endfor %}<tt><br/></tt>            <span class="ta">&lt;/li&gt;</span><tt><br/></tt>            {% endif %}<tt><br/><br/></tt>        {% endfor %}<tt><br/></tt>    <span class="ta">&lt;/ul&gt;</span> <tt><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<p>
增加了一重循环，在每月文章内再分别列出文章的题目，第二个 <code>assign&#95;to</code> 的用法比较有趣。
</p>
<br/><br/>
<h3>
Hack 6: Gravatar 支持
</h3>
<br/><br/>
<p>
Mephisto 的管理界面直接支持 Gravatar 的头像，但我一开始没有找到对应的 filter，而插件工作也始终不正常。困扰了许久后在 Google Groups 上的 <a href="http://groups.google.com/group/MephistoBlog">Mephisto Blog 小组</a>找到了答案，原来 filter 就在 mephisto/apps/helper/url&#95;filters.rb 这个文件中：
</p>
<br/><br/>
<table class="CodeRay"><tr>
<br/>
<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt><br/></tt>2<tt><br/></tt>3<tt><br/></tt>4<tt><br/></tt><strong>5</strong><tt><br/><br/></tt>6<tt><br/></tt>7<tt><br/></tt>8<tt><br/></tt>9<tt><br/></tt><strong>10</strong><tt><br/></tt>11<tt><br/></tt>12<tt><br/></tt></pre></td>
<br/>
<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><tt><br/><br/></tt>    <span class="c">####################################################</span><tt><br/></tt>      <span class="r">def</span> <span class="fu">gravatar_author</span>(author, size=<span class="i">80</span>, default=<span class="pc">nil</span>)<tt><br/></tt>        <span class="r">return</span> <span class="s"><span class="dl">'</span><span class="dl">'</span></span> <span class="r">unless</span> author[<span class="s"><span class="dl">'</span><span class="k">email</span><span class="dl">'</span></span>]<tt><br/><br/></tt>        url = <span class="s"><span class="dl">&quot;</span><span class="k">http://www.gravatar.com/avatar.php?<tt><br/></tt>    size=</span><span class="il"><span class="dl">#{</span>size<span class="dl">}</span></span><span class="k">&amp;gravatar_id=</span><span class="il"><span class="dl">#{</span><span class="co">Digest</span>::<span class="co">MD5</span>.hexdigest(author[<span class="s"><span class="dl">'</span><span class="k">email</span><span class="dl">'</span></span>])<span class="dl">}</span></span><span class="dl">&quot;</span></span><tt><br/><br/></tt>        url &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">&amp;default=</span><span class="il"><span class="dl">#{</span>default<span class="dl">}</span></span><span class="dl">&quot;</span></span> <span class="r">if</span> default<tt><br/></tt><tt><br/></tt>        image_tag url, <span class="sy">:class</span> =&gt; <span class="s"><span class="dl">'</span><span class="k">gravatar</span><span class="dl">'</span></span>, <span class="sy">:size</span> =&gt;<tt><br/><br/></tt>    <span class="s"><span class="dl">&quot;</span><span class="il"><span class="dl">#{</span>size<span class="dl">}</span></span><span class="k">x</span><span class="il"><span class="dl">#{</span>size<span class="dl">}</span></span><span class="dl">&quot;</span></span>, <span class="sy">:alt</span> =&gt; <span class="s"><span class="dl">&quot;</span><span class="k">author['login']</span><span class="dl">&quot;</span></span><tt><br/></tt>      <span class="r">end</span><tt><br/><br/></tt>      <span class="c">####################################################</span><tt><br/></tt></pre></td>
<br/>
</tr></table>
<br/><br/>
<p>
修改一下评论模板，在合适的地方加上 <code>{{ comment &#124; gravatar: 32, &quot;http://snakehsu.info/contacts.png&quot;}}</code>，即可看到评论者的 gravatar。两个参数分别是头像的大小和没有头像时的默认图像。
</p>
<br/><br/>
<p>
顺便说一句，前几天 gravatar 工作不正常是因为数据库和服务器的配合问题，目前已经基本解决，但是需要用户自己登录 gravatar 再重新提交一次头像。
</p>
<br/><br/>
<h3>
Hack 7 &amp; 8: 搜索和 Tag Cloud
</h3>
<br/><br/>
<p>
如上面所说，内置搜索的结果只能给出最初十几个，所以我试图用 <a href="http://www.google.com/coop/">Google 定制搜索引擎</a> 来解决这个问题，不过看来 Google 还没有来得及索引这个新地址，所以这几天内估计用 Google 搜不到这里的东西，且看看过一周后怎么样。
</p>
<br/><br/>
<p>
Tag Cloud 也是用的现成的<a href="http://ralree.info/2007/2/25/mephisto-tag-cloud-plugin">插件</a>，唯一的问题是域名不一致，因为它认为我的 blog 的基础地址是 snakehsu.info 而不是 snakehsu.info/main/，我也没空钻研 URL 重写的问题，就直接改了插件的源文件了事，这个是我唯一的一处”硬“修改。
</p>
<br/><br/>
<p>
现在这个新 blog 基本实现了过去 Wordpress blog 的所有功能，有些地方还更方便，比如内置的 Gravatar 支持和 Markdown （类似 emacs-wiki 的标记语言）。折腾了好久，现在基本可以熟练地在共享主机上安装 Ruby on Rails 程序了......
</p></div>
<h2>
Comments
</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>
量子公民
</div>
<div class='content'>
你Blog的RSS源全部出错，无任何输出。快修复吧～
</div>
</div>
<div class='comment'>
<div class='author'>
snakehsu
</div>
<div class='content'>
目前解决了一半，自动发现的 atom 可以用了。之前错误原因是导入原来的数据库时 userid 与现在的不一致，导致 ruby 出错。<br>现在页面上 sidebar 里的 atom 链接还有问题，要把 /main 去掉才能用，可能跟我之前硬改设置有关系，但改回来后问题依旧，可能是 cache 没有清除的缘故。
</div>
</div>
</div>


